<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Lá»‹ch sá»­ Ä‘áº·t phÃ²ng</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h2>ğŸ“œ Lá»‹ch sá»­ Ä‘áº·t phÃ²ng</h2>

<h3>ğŸŸ¢ Booking Ä‘ang hoáº¡t Ä‘á»™ng</h3>
<div id="activeBookingList">Äang táº£i...</div>

<hr>

<h3>ğŸ”´ Lá»‹ch sá»­ há»§y</h3>
<div id="cancelledBookingList">ChÆ°a cÃ³</div>


<script>
const token = localStorage.getItem("token");
const email = localStorage.getItem("email");

if (!token || !email) {
    alert("Vui lÃ²ng Ä‘Äƒng nháº­p");
    location.href = "index.html";
}

fetch(`https://ominous-trout-v67rqxvv9j4v2w7rr-8082.app.github.dev/bookings/user?email=${email}`, {
    headers: {
        "Authorization": "Bearer " + token
    }
})
.then(res => {
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
})
.then(bookings => {
    const activeEl = document.getElementById("activeBookingList");
    const cancelledEl = document.getElementById("cancelledBookingList");

    const active = bookings.filter(b => b.status !== "CANCELLED");
    const cancelled = bookings.filter(b => b.status === "CANCELLED");

    activeEl.innerHTML = active.length === 0
    ? "<p>KhÃ´ng cÃ³ booking Ä‘ang hoáº¡t Ä‘á»™ng</p>"
    : activeEl.innerHTML = active.length === 0
  ? "<p>KhÃ´ng cÃ³ booking Ä‘ang hoáº¡t Ä‘á»™ng</p>"
  : active.map(b => `
    <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px">

      <p><strong>MÃ£:</strong> ${b.id}</p>
      <p><strong>PhÃ²ng:</strong> ${b.roomId}</p>
      <p>${b.checkIn} â†’ ${b.checkOut}</p>

      ${
        b.status === "PENDING_PAYMENT"
          ? `
            <button onclick="payBooking(${b.id})">ğŸ’³ Thanh toÃ¡n</button>
            <button onclick="cancelBooking(${b.id})">âŒ Há»§y</button>
          `
          : ""
      }

      ${
        b.status === "PAYMENT_FAILED"
          ? `
            <p style="color:red">âŒ Thanh toÃ¡n tháº¥t báº¡i</p>
            <button onclick="payBooking(${b.id})">ğŸ’³ Thanh toÃ¡n láº¡i</button>
            <button onclick="cancelBooking(${b.id})">âŒ Há»§y</button>
          `
          : ""
      }

      ${
        b.status === "CONFIRMED"
          ? `<p style="color:green">âœ… ÄÃ£ thanh toÃ¡n</p>`
          : ""
      }

    </div>
  `).join("");


    cancelledEl.innerHTML = cancelled.length === 0
        ? "<p>ChÆ°a cÃ³ booking bá»‹ há»§y</p>"
        : cancelled.map(b => `
            <div style="color:red">
                <p>MÃ£: ${b.id}</p>
                <p>PhÃ²ng: ${b.roomId}</p>
                <p>${b.checkIn} â†’ ${b.checkOut}</p>
                <p>âŒ ÄÃ£ há»§y</p>
            </div>
        `).join("");
})
.catch(err => {
    console.error(err);
    alert("KhÃ´ng táº£i Ä‘Æ°á»£c lá»‹ch sá»­ Ä‘áº·t phÃ²ng");
});
</script>


<script>
function cancelBooking(bookingId) {
    if (!confirm("Báº¡n cháº¯c cháº¯n muá»‘n há»§y booking nÃ y?")) return;

    fetch(`https://ominous-trout-v67rqxvv9j4v2w7rr-8082.app.github.dev/bookings/${bookingId}/cancel`, {
        method: "PUT"
    })
    .then(res => {
        if (!res.ok) throw new Error("Cancel failed");
        alert("âœ… ÄÃ£ há»§y booking");
        location.reload();
    })
    .catch(err => {
        console.error(err);
        alert("âŒ Há»§y booking tháº¥t báº¡i");
    });
}
</script>

<script>
function payBooking(bookingId) {
    localStorage.setItem("lastBookingId", bookingId);
    window.location.href = "payment.html";
}
</script>

</body>
</html>
